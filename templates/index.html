<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìà Stock Anomaly Detector</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0e1117;
            color: #fafafa;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: #262730;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        h1 {
            margin-bottom: 10px;
        }

        h2 {
            margin: 20px 0 10px 0;
            font-size: 18px;
            color: #fafafa;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        @media (max-width: 1200px) {
            .metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .metric-card {
            background: #262730;
            padding: 15px;
            border-radius: 8px;
        }

        .metric-label {
            font-size: 12px;
            color: #a3a8b4;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }

        .metric-delta {
            font-size: 14px;
            margin-top: 5px;
        }

        .positive { color: #00cc96; }
        .negative { color: #ef553b; }

        select, input[type="range"] {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            background: #0e1117;
            color: #fafafa;
            border: 1px solid #464651;
            border-radius: 4px;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        button {
            padding: 10px;
            background: #ff4b4b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover { background: #cc3c3c; }
        button:disabled { background: #464651; cursor: not-allowed; }
        button.primary { background: #0068c9; }
        button.primary:hover { background: #005aa6; }

        .speed-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin: 10px 0;
        }

        .speed-buttons button {
            padding: 8px;
            font-size: 12px;
        }

        .speed-buttons button.active {
            background: #0068c9;
        }

        .info-section {
            background: #262730;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 14px;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
            margin: 10px 0;
        }

        .status-streaming { background: #00cc96; color: white; }
        .status-paused { background: #ffa500; color: white; }
        .status-stopped { background: #464651; color: white; }

        #chart {
            margin: 20px 0;
            background: #262730;
            border-radius: 8px;
            padding: 10px;
            height: 500px;
        }

        .anomaly-section {
            background: #262730;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .anomaly-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .anomaly-badge {
            background: #ff4b4b;
            color: white;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
        }

        .anomaly-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .anomaly-item {
            background: #0e1117;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #ff4b4b;
        }

        .anomaly-item.severity-1 { border-left-color: #ffa500; }
        .anomaly-item.severity-2 { border-left-color: #ff8c00; }
        .anomaly-item.severity-3 { border-left-color: #ff4b4b; }
        .anomaly-item.severity-4 { border-left-color: #dc143c; }

        .anomaly-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .anomaly-type {
            font-weight: bold;
            text-transform: capitalize;
        }

        .anomaly-timestamp {
            color: #a3a8b4;
            font-size: 12px;
        }

        .anomaly-description {
            color: #fafafa;
            font-size: 14px;
            margin-top: 5px;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #464651;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #0068c9;
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .slider-container {
            margin: 15px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .slider {
            width: 100%;
            height: 6px;
            background: #464651;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #0068c9;
            border-radius: 50%;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #0068c9;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .collapsible-section {
            margin-bottom: 10px;
        }

        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
        }

        .collapsible-header::before {
            content: '‚ñ∂';
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.3s;
        }

        .collapsible-header.open::before {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.open {
            max-height: 1000px;
        }

        .code-editor {
            width: 100%;
            min-height: 200px;
            background: #0e1117;
            color: #fafafa;
            border: 1px solid #464651;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            margin: 10px 0;
        }

        .custom-anomaly-card {
            background: #0e1117;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 3px solid #0068c9;
        }

        .custom-anomaly-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .custom-anomaly-name {
            font-weight: bold;
            color: #0068c9;
        }

        .delete-btn {
            background: #ef553b;
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
        }

        .delete-btn:hover {
            background: #cc3c3c;
        }

        .example-link {
            color: #0068c9;
            cursor: pointer;
            text-decoration: underline;
            font-size: 12px;
            margin: 5px 10px;
            display: inline-block;
        }

        .example-link:hover {
            color: #005aa6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h1>üìà Stock Anomaly Detector</h1>
            <p style="color: #a3a8b4; margin-bottom: 20px;">Real-time streaming ‚Ä¢ No page reloads</p>

            <h2>‚öôÔ∏è Settings</h2>
            <label for="fileSelect" style="color: #a3a8b4; font-size: 12px;">Select Stock Data</label>
            <select id="fileSelect" onchange="loadFile()">
                {% for file in data_files %}
                <option value="{{ file }}">{{ file.replace('.csv', '').replace('_', ' ').upper() }}</option>
                {% endfor %}
            </select>

            <h2>üéÆ Controls</h2>
            <div id="statusBadge" class="status-badge status-stopped">‚èπÔ∏è Stopped</div>
            <div class="button-group">
                <button id="startBtn" class="primary" onclick="startStreaming()">‚ñ∂Ô∏è Start</button>
                <button id="pauseBtn" onclick="pauseStreaming()">‚è∏Ô∏è Pause</button>
                <button id="resetBtn" onclick="resetStreaming()">üîÑ Reset</button>
            </div>

            <h2>‚ö° Playback Speed</h2>
            <div class="speed-buttons">
                <button onclick="setSpeed(1)" data-speed="1" class="active">1x</button>
                <button onclick="setSpeed(2)" data-speed="2">2x</button>
                <button onclick="setSpeed(3)" data-speed="3">3x</button>
                <button onclick="setSpeed(5)" data-speed="5">5x</button>
                <button onclick="setSpeed(10)" data-speed="10">10x</button>
                <button onclick="setSpeed(100)" data-speed="100">100x</button>
            </div>

            <h2>üìä Chart Window</h2>
            <input type="range" id="windowSize" min="50" max="500" step="50" value="50" oninput="setWindowSize(this.value)">
            <p style="color: #a3a8b4; font-size: 12px;">Showing last <span id="windowSizeLabel">50</span> points</p>

            <div class="toggle-container" style="margin-top: 15px;">
                <span>üîí Lock to Latest Data</span>
                <div class="toggle-switch active" id="autoFollowToggle" onclick="toggleAutoFollow(this)">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <p style="color: #a3a8b4; font-size: 11px; margin-top: 5px;">When off, you can pan/zoom freely</p>

            <div class="info-section">
                <h2>üìä Streaming Info</h2>
                <div class="info-row">
                    <span>Total Points:</span>
                    <span id="totalPoints">0</span>
                </div>
                <div class="info-row">
                    <span>Current:</span>
                    <span id="currentIndex">0</span>
                </div>
                <div class="info-row">
                    <span>Progress:</span>
                    <span id="progress">0.0%</span>
                </div>
            </div>

            <div class="info-section">
                <h2>üìÖ Data Range</h2>
                <div class="info-row">
                    <span>From:</span>
                    <span id="dateFrom">-</span>
                </div>
                <div class="info-row">
                    <span>To:</span>
                    <span id="dateTo">-</span>
                </div>
            </div>

            <div class="info-section">
                <div class="collapsible-section">
                    <h2 class="collapsible-header" onclick="toggleSection(this)">üö® Anomaly Detection</h2>
                    <div class="collapsible-content">
                        <div style="margin-top: 10px;">
                            <div class="toggle-container">
                                <span>Price Spikes</span>
                                <div class="toggle-switch active" onclick="toggleAnomalyType('price_spike', this)" data-type="price_spike">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                            <div class="toggle-container">
                                <span>Price Drops</span>
                                <div class="toggle-switch active" onclick="toggleAnomalyType('price_drop', this)" data-type="price_drop">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                            <div class="toggle-container">
                                <span>Volume Spikes</span>
                                <div class="toggle-switch active" onclick="toggleAnomalyType('volume_spike', this)" data-type="volume_spike">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                            <div class="toggle-container">
                                <span>Volatility Spikes</span>
                                <div class="toggle-switch active" onclick="toggleAnomalyType('volatility_spike', this)" data-type="volatility_spike">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                            <div class="toggle-container">
                                <span>Gaps</span>
                                <div class="toggle-switch active" onclick="toggleAnomalyType('gap', this)" data-type="gap">
                                    <div class="toggle-slider"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <h2 class="collapsible-header" onclick="toggleSection(this)">‚öôÔ∏è Detection Settings</h2>
                    <div class="collapsible-content">
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Window Size</span>
                                <span id="windowSizeValue">20</span>
                            </div>
                            <input type="range" class="slider" id="anomalyWindowSize" min="10" max="100" step="5" value="20" oninput="updateAnomalyConfig()">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Price Sensitivity</span>
                                <span id="zThresholdValue">3.0</span>
                            </div>
                            <input type="range" class="slider" id="zThreshold" min="1.5" max="5.0" step="0.1" value="3.0" oninput="updateAnomalyConfig()">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Volume Threshold</span>
                                <span id="volumeThresholdValue">2.5</span>
                            </div>
                            <input type="range" class="slider" id="volumeThreshold" min="1.5" max="5.0" step="0.1" value="2.5" oninput="updateAnomalyConfig()">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>Volatility Threshold</span>
                                <span id="volatilityThresholdValue">2.0</span>
                            </div>
                            <input type="range" class="slider" id="volatilityThreshold" min="1.0" max="4.0" step="0.1" value="2.0" oninput="updateAnomalyConfig()">
                        </div>

                        <button onclick="clearAnomalies()" style="width: 100%; margin-top: 10px;">Clear All Anomalies</button>
                    </div>
                </div>

                <div class="collapsible-section">
                    <h2 class="collapsible-header" onclick="toggleSection(this)">üíª Custom Anomalies</h2>
                    <div class="collapsible-content">
                        <p style="font-size: 12px; color: #a3a8b4; margin-top: 10px;">
                            Write Python code to detect custom anomalies. Your function receives current and window data.
                        </p>

                        <div style="background: #0e1117; padding: 10px; border-radius: 4px; border-left: 3px solid #0068c9; margin: 10px 0; font-size: 11px; font-family: 'Courier New', monospace;">
                            <strong style="color: #0068c9;">Available Variables:</strong><br><br>
                            <strong>window_data</strong> (DataFrame):<br>
                            &nbsp;&nbsp;‚Ä¢ Open, High, Low, Close, Volume<br>
                            &nbsp;&nbsp;‚Ä¢ Datetime<br>
                            &nbsp;&nbsp;Ex: window_data['Close'].mean()<br><br>

                            <strong>current_row</strong> (Series):<br>
                            &nbsp;&nbsp;‚Ä¢ Open, High, Low, Close, Volume<br>
                            &nbsp;&nbsp;‚Ä¢ Datetime<br>
                            &nbsp;&nbsp;Ex: current_row['Close']<br><br>

                            <strong>current_index</strong> (int):<br>
                            &nbsp;&nbsp;‚Ä¢ Position in dataset<br><br>

                            <strong>Libraries:</strong><br>
                            &nbsp;&nbsp;‚Ä¢ pd (pandas), np (numpy)<br><br>

                            <strong>Set these variables:</strong><br>
                            &nbsp;&nbsp;‚Ä¢ <span style="color: #00cc96;">description</span> = "Your message"<br>
                            &nbsp;&nbsp;‚Ä¢ <span style="color: #00cc96;">severity</span> = 1-4 (Low to Critical)<br>
                            &nbsp;&nbsp;‚Ä¢ <span style="color: #00cc96;">return True</span> to trigger anomaly
                        </div>

                        <label style="font-size: 14px; margin-top: 10px; display: block;">Anomaly Name:</label>
                        <input type="text" id="customAnomalyName" placeholder="e.g., Large Price Jump" style="width: 100%; padding: 8px; margin: 5px 0;">

                        <label style="font-size: 14px; margin-top: 10px; display: block;">Detection Code:</label>
                        <textarea id="customAnomalyCode" class="code-editor" placeholder="# Your code here...
# Example:
if len(window_data) > 0:
    avg_price = window_data['Close'].mean()
    current_price = current_row['Close']

    if current_price > avg_price * 1.05:
        description = f'Price ${current_price:.2f} is 5% above average'
        severity = 2
        return True

return False"></textarea>

                        <div style="margin: 10px 0;">
                            <strong style="font-size: 12px;">Examples:</strong><br>
                            <a class="example-link" onclick="loadExample('rsi')">RSI Overbought/Oversold</a>
                            <a class="example-link" onclick="loadExample('consecutive')">Consecutive Drops</a>
                            <a class="example-link" onclick="loadExample('support')">Support/Resistance Break</a>
                        </div>

                        <button onclick="addCustomAnomaly()" class="primary" style="width: 100%; margin-top: 10px;">Add Custom Anomaly</button>

                        <div id="customAnomaliesList" style="margin-top: 15px;">
                            <!-- Custom anomalies will be listed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="metrics" id="metrics">
                <div class="metric-card">
                    <div class="metric-label">Data Points Loaded</div>
                    <div class="metric-value" id="metricPoints">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Current Price</div>
                    <div class="metric-value" id="metricPrice">$0.00</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Change</div>
                    <div class="metric-value" id="metricChange">$0.00</div>
                    <div class="metric-delta" id="metricChangePct">0.00%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Anomalies Detected</div>
                    <div class="metric-value" id="metricAnomalies">0</div>
                </div>
            </div>

            <div id="chart"></div>

            <!-- Anomaly Display Section -->
            <div class="anomaly-section">
                <div class="anomaly-header">
                    <h2 style="margin: 0;">üö® Detected Anomalies</h2>
                    <div class="anomaly-badge" id="anomalyCount">0</div>
                </div>
                <div id="anomalyList" class="anomaly-list">
                    <p style="color: #a3a8b4; text-align: center;">No anomalies detected yet. Start streaming to detect anomalies.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentSpeed = 1;
        let allAnomalies = [];
        let customAnomalies = [];
        let autoFollow = true;  // Auto-follow new data
        let isStreaming = false;

        // Keep ALL data on client side
        let allChartData = {
            datetime: [],
            open: [],
            high: [],
            low: [],
            close: [],
            volume: []
        };

        // Initialize with first file
        window.onload = function() {
            loadFile();
        };

        // Collapsible sections
        function toggleSection(header) {
            header.classList.toggle('open');
            const content = header.nextElementSibling;
            content.classList.toggle('open');
        }

        // Toggle anomaly detection type
        function toggleAnomalyType(type, element) {
            element.classList.toggle('active');
            const enabled = element.classList.contains('active');
            socket.emit('toggle_anomaly_type', { type: type, enabled: enabled });
        }

        // Update anomaly detection configuration
        function updateAnomalyConfig() {
            const config = {
                window_size: parseInt(document.getElementById('anomalyWindowSize').value),
                z_threshold: parseFloat(document.getElementById('zThreshold').value),
                volume_threshold: parseFloat(document.getElementById('volumeThreshold').value),
                volatility_threshold: parseFloat(document.getElementById('volatilityThreshold').value)
            };

            // Update display values
            document.getElementById('windowSizeValue').textContent = config.window_size;
            document.getElementById('zThresholdValue').textContent = config.z_threshold.toFixed(1);
            document.getElementById('volumeThresholdValue').textContent = config.volume_threshold.toFixed(1);
            document.getElementById('volatilityThresholdValue').textContent = config.volatility_threshold.toFixed(1);

            socket.emit('update_anomaly_config', config);
        }

        // Clear all anomalies
        function clearAnomalies() {
            socket.emit('clear_anomalies');
            allAnomalies = [];
            updateAnomalyDisplay();
        }

        // Load example custom anomaly code
        function loadExample(type) {
            const examples = {
                'rsi': {
                    name: 'RSI Overbought/Oversold',
                    code: '# Calculate RSI and detect overbought/oversold conditions\n' +
                          '# Returns True if anomaly detected, False otherwise\n\n' +
                          'if len(window_data) < 14:\n' +
                          '    return False\n\n' +
                          '# Calculate RSI\n' +
                          'delta = window_data[\'Close\'].diff()\n' +
                          'gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()\n' +
                          'loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()\n' +
                          'rs = gain / loss\n' +
                          'rsi = 100 - (100 / (1 + rs))\n' +
                          'current_rsi = rsi.iloc[-1]\n\n' +
                          '# Detect overbought (>70) or oversold (<30)\n' +
                          'if current_rsi > 70:\n' +
                          '    description = f"RSI Overbought: {current_rsi:.2f}"\n' +
                          '    return True\n' +
                          'elif current_rsi < 30:\n' +
                          '    description = f"RSI Oversold: {current_rsi:.2f}"\n' +
                          '    return True\n\n' +
                          'return False'
                },
                'consecutive': {
                    name: 'Consecutive Price Drops',
                    code: '# Detect 3 or more consecutive price drops\n' +
                          '# Returns True if anomaly detected, False otherwise\n\n' +
                          'if len(window_data) < 3:\n' +
                          '    return False\n\n' +
                          '# Check last 3 closes\n' +
                          'recent_closes = window_data[\'Close\'].tail(3).values\n' +
                          'drops = 0\n\n' +
                          'for i in range(1, len(recent_closes)):\n' +
                          '    if recent_closes[i] < recent_closes[i-1]:\n' +
                          '        drops += 1\n\n' +
                          'if drops >= 3:\n' +
                          '    pct_drop = ((recent_closes[-1] - recent_closes[0]) / recent_closes[0]) * 100\n' +
                          '    description = f"3 consecutive drops: {pct_drop:.2f}% total decline"\n' +
                          '    return True\n\n' +
                          'return False'
                },
                'support': {
                    name: 'Support Level Break',
                    code: '# Detect when price breaks below support level\n' +
                          '# Returns True if anomaly detected, False otherwise\n\n' +
                          'if len(window_data) < 20:\n' +
                          '    return False\n\n' +
                          '# Calculate support level (lowest low in window)\n' +
                          'support_level = window_data[\'Low\'].min()\n' +
                          'current_price = current_row[\'Close\']\n' +
                          'previous_price = window_data[\'Close\'].iloc[-1]\n\n' +
                          '# Check if price just broke below support\n' +
                          'if previous_price > support_level and current_price < support_level:\n' +
                          '    break_pct = ((support_level - current_price) / support_level) * 100\n' +
                          '    description = f"Support break at ${support_level:.2f} by {break_pct:.2f}%"\n' +
                          '    return True\n\n' +
                          'return False'
                }
            };

            const example = examples[type];
            if (example) {
                document.getElementById('customAnomalyName').value = example.name;
                document.getElementById('customAnomalyCode').value = example.code;
            }
        }

        // Add custom anomaly
        function addCustomAnomaly() {
            const name = document.getElementById('customAnomalyName').value.trim();
            const code = document.getElementById('customAnomalyCode').value.trim();

            if (!name || !code) {
                alert('Please provide both a name and code for the custom anomaly');
                return;
            }

            const customAnomaly = {
                id: Date.now(),
                name: name,
                code: code,
                enabled: true
            };

            customAnomalies.push(customAnomaly);
            socket.emit('add_custom_anomaly', customAnomaly);

            // Clear inputs
            document.getElementById('customAnomalyName').value = '';
            document.getElementById('customAnomalyCode').value = '';

            updateCustomAnomaliesList();
        }

        // Delete custom anomaly
        function deleteCustomAnomaly(id) {
            customAnomalies = customAnomalies.filter(a => a.id !== id);
            socket.emit('delete_custom_anomaly', { id: id });
            updateCustomAnomaliesList();
        }

        // Toggle custom anomaly
        function toggleCustomAnomaly(id, element) {
            const anomaly = customAnomalies.find(a => a.id === id);
            if (anomaly) {
                anomaly.enabled = !anomaly.enabled;
                element.classList.toggle('active');
                socket.emit('toggle_custom_anomaly', { id: id, enabled: anomaly.enabled });
            }
        }

        // Update custom anomalies list display
        function updateCustomAnomaliesList() {
            const list = document.getElementById('customAnomaliesList');

            if (customAnomalies.length === 0) {
                list.innerHTML = '<p style="color: #a3a8b4; font-size: 12px; text-align: center;">No custom anomalies added yet.</p>';
                return;
            }

            list.innerHTML = customAnomalies.map(anomaly => `
                <div class="custom-anomaly-card">
                    <div class="custom-anomaly-header">
                        <span class="custom-anomaly-name">${anomaly.name}</span>
                        <div>
                            <div class="toggle-switch ${anomaly.enabled ? 'active' : ''}"
                                 onclick="toggleCustomAnomaly(${anomaly.id}, this)"
                                 style="display: inline-block; width: 40px; height: 20px; margin-right: 10px;">
                                <div class="toggle-slider"></div>
                            </div>
                            <button class="delete-btn" onclick="deleteCustomAnomaly(${anomaly.id})">Delete</button>
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #a3a8b4; margin-top: 5px;">
                        ${anomaly.code.split('\n').length} lines of code
                    </div>
                </div>
            `).join('');
        }

        // Update anomaly display
        function updateAnomalyDisplay() {
            const anomalyList = document.getElementById('anomalyList');
            const anomalyCount = document.getElementById('anomalyCount');
            const metricAnomalies = document.getElementById('metricAnomalies');

            if (allAnomalies.length === 0) {
                anomalyList.innerHTML = '<p style="color: #a3a8b4; text-align: center;">No anomalies detected yet.</p>';
                anomalyCount.textContent = '0';
                metricAnomalies.textContent = '0';
                return;
            }

            // Sort by timestamp (most recent first)
            const sorted = [...allAnomalies].sort((a, b) => b.index - a.index);

            // Display anomalies
            anomalyList.innerHTML = sorted.map(anomaly => {
                const severityClass = `severity-${anomaly.severity}`;
                const severityNames = ['', 'Low', 'Medium', 'High', 'Critical'];

                // Check if this is a custom anomaly (description starts with [)
                const isCustom = anomaly.description.startsWith('[');
                let typeDisplay = anomaly.type.replace('_', ' ');
                let descriptionDisplay = anomaly.description;

                if (isCustom) {
                    // Extract custom name from description format: [CustomName] Description
                    const match = anomaly.description.match(/^\[([^\]]+)\]\s*(.*)$/);
                    if (match) {
                        typeDisplay = match[1]; // Custom name
                        descriptionDisplay = match[2]; // Description without [name]
                    }
                }

                const deviationText = (isCustom || anomaly.deviation === 0)
                    ? ''
                    : ` | Deviation: ${anomaly.deviation.toFixed(2)}œÉ`;

                return `
                    <div class="anomaly-item ${severityClass}">
                        <div class="anomaly-item-header">
                            <span class="anomaly-type">${typeDisplay}</span>
                            <span class="anomaly-timestamp">${anomaly.timestamp}</span>
                        </div>
                        <div style="font-size: 12px; color: #a3a8b4; margin-bottom: 5px;">
                            Severity: ${severityNames[anomaly.severity]}${deviationText}
                        </div>
                        <div class="anomaly-description">${descriptionDisplay}</div>
                    </div>
                `;
            }).join('');

            anomalyCount.textContent = allAnomalies.length;
            metricAnomalies.textContent = allAnomalies.length;
        }

        function loadFile() {
            const filename = document.getElementById('fileSelect').value;
            fetch('/api/load_file', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('totalPoints').textContent = data.total_points.toLocaleString();
                    document.getElementById('dateFrom').textContent = data.date_from;
                    document.getElementById('dateTo').textContent = data.date_to;

                    // Clear anomalies when loading new file
                    allAnomalies = [];
                    updateAnomalyDisplay();
                }
            });
        }

        function startStreaming() {
            socket.emit('start_streaming');
            isStreaming = true;
            document.getElementById('startBtn').classList.add('primary');
            document.getElementById('pauseBtn').classList.remove('primary');
        }

        function pauseStreaming() {
            socket.emit('pause_streaming');
            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.classList.toggle('primary');
        }

        function resetStreaming() {
            socket.emit('reset_streaming');
            isStreaming = false;
            autoFollow = true;

            // Reset button states
            document.getElementById('startBtn').classList.add('primary');
            document.getElementById('pauseBtn').classList.remove('primary');
            document.getElementById('autoFollowToggle').classList.add('active');

            // Clear anomalies on reset
            allAnomalies = [];
            updateAnomalyDisplay();

            // Clear ALL accumulated chart data
            allChartData = {
                datetime: [],
                open: [],
                high: [],
                low: [],
                close: [],
                volume: []
            };

            // Clear the chart
            Plotly.purge('chart');

            // Reset metrics
            document.getElementById('metricPoints').textContent = '0';
            document.getElementById('metricPrice').textContent = '$0.00';
            document.getElementById('metricChange').textContent = '$0.00';
            document.getElementById('metricChangePct').textContent = '0.00%';
            document.getElementById('metricAnomalies').textContent = '0';
            document.getElementById('currentIndex').textContent = '0';
            document.getElementById('progress').textContent = '0.0%';
        }

        function setSpeed(speed) {
            currentSpeed = speed;
            socket.emit('set_speed', { speed });

            // Update button states
            document.querySelectorAll('.speed-buttons button').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.speed) === speed) {
                    btn.classList.add('active');
                }
            });
        }

        function setWindowSize(size) {
            document.getElementById('windowSizeLabel').textContent = size;
            socket.emit('set_window_size', { size: parseInt(size) });
        }

        function toggleAutoFollow(element) {
            autoFollow = !autoFollow;
            element.classList.toggle('active');
        }

        // Detect when user manually pans/zooms and disable auto-follow
        function setupChartInteraction() {
            const chartDiv = document.getElementById('chart');
            chartDiv.on('plotly_relayout', function(eventdata) {
                // Check if user manually changed the axis range
                if (eventdata['xaxis.range[0]'] !== undefined || eventdata['xaxis.autorange'] === false) {
                    if (autoFollow && isStreaming) {
                        autoFollow = false;
                        document.getElementById('autoFollowToggle').classList.remove('active');
                    }
                }
            });
        }

        // Handle status updates
        socket.on('status_update', function(data) {
            const badge = document.getElementById('statusBadge');
            const status = data.status;

            if (status === 'streaming') {
                badge.textContent = 'üî¥ Streaming';
                badge.className = 'status-badge status-streaming';
            } else if (status === 'paused') {
                badge.textContent = '‚è∏Ô∏è Paused';
                badge.className = 'status-badge status-paused';
            } else {
                badge.textContent = '‚èπÔ∏è Stopped';
                badge.className = 'status-badge status-stopped';
            }
        });

        // Handle data updates (NO PAGE RELOAD!)
        socket.on('data_update', function(data) {
            // Update metrics
            document.getElementById('metricPoints').textContent = data.current_index.toLocaleString();
            document.getElementById('metricPrice').textContent = '$' + data.current_price.toFixed(2);

            const change = data.current_price - data.start_price;
            const changePct = ((change / data.start_price) * 100);

            document.getElementById('metricChange').textContent = '$' + change.toFixed(2);
            document.getElementById('metricChangePct').textContent = changePct.toFixed(2) + '%';
            document.getElementById('metricChangePct').className = 'metric-delta ' + (changePct >= 0 ? 'positive' : 'negative');

            // Update progress
            document.getElementById('currentIndex').textContent = data.current_index.toLocaleString();
            const progress = (data.current_index / data.total_points * 100).toFixed(1);
            document.getElementById('progress').textContent = progress + '%';

            // Update anomalies
            if (data.anomalies) {
                // Merge new anomalies with existing ones (avoid duplicates by index)
                const existingIndices = new Set(allAnomalies.map(a => a.index));
                data.anomalies.forEach(anomaly => {
                    if (!existingIndices.has(anomaly.index)) {
                        allAnomalies.push(anomaly);
                    }
                });
                updateAnomalyDisplay();
            }

            if (data.anomaly_count !== undefined) {
                document.getElementById('metricAnomalies').textContent = data.anomaly_count;
            }

            // Accumulate data on client side (keep all historical data)
            // Server sends last 100 points, but we merge with existing data
            for (let i = 0; i < data.datetime.length; i++) {
                const currentLength = allChartData.datetime.length;
                // Only add if this is new data (not already in our array)
                if (currentLength === 0 || allChartData.datetime[currentLength - 1] !== data.datetime[i]) {
                    allChartData.datetime.push(data.datetime[i]);
                    allChartData.open.push(data.open[i]);
                    allChartData.high.push(data.high[i]);
                    allChartData.low.push(data.low[i]);
                    allChartData.close.push(data.close[i]);
                    allChartData.volume.push(data.volume[i]);
                }
            }

            // Update chart (smooth, no reload!) using ALL accumulated data
            // Use sequential x-axis to remove gaps
            const xIndices = Array.from({length: allChartData.close.length}, (_, i) => i);

            // Price candlestick trace using ALL accumulated data
            const traces = [{
                x: xIndices,
                close: allChartData.close,
                decreasing: {line: {color: '#ef553b'}},
                high: allChartData.high,
                increasing: {line: {color: '#00cc96'}},
                low: allChartData.low,
                open: allChartData.open,
                type: 'candlestick',
                xaxis: 'x',
                yaxis: 'y',
                name: 'Price'
            }];

            // Add anomaly markers - separate price and volume anomalies
            if (data.anomalies && data.anomalies.length > 0) {
                // Price anomalies (for price chart)
                const priceAnomalyX = [];
                const priceAnomalyY = [];
                const priceAnomalyText = [];
                const priceAnomalyColors = [];

                // Volume anomalies (for volume chart)
                const volumeAnomalyX = [];
                const volumeAnomalyY = [];
                const volumeAnomalyText = [];
                const volumeAnomalyColors = [];

                data.anomalies.forEach(anomaly => {
                    // Index is now absolute since we're sending all data from start
                    if (anomaly.index >= 0 && anomaly.index < allChartData.close.length) {
                        // Color by severity
                        const colors = ['', '#ffa500', '#ff8c00', '#ff4b4b', '#dc143c'];
                        const color = colors[anomaly.severity] || '#ff4b4b';

                        // Separate volume anomalies from price anomalies
                        if (anomaly.type === 'volume_spike') {
                            volumeAnomalyX.push(anomaly.index);
                            volumeAnomalyY.push(anomaly.value);
                            volumeAnomalyText.push(anomaly.description);
                            volumeAnomalyColors.push(color);
                        } else {
                            // For price anomalies, use the close price at that index
                            // This prevents volatility spikes (which have small values) from ruining the scale
                            const yValue = anomaly.type === 'volatility_spike'
                                ? allChartData.close[anomaly.index]  // Use actual price for volatility anomalies
                                : anomaly.value;             // Use anomaly value for price/gap anomalies

                            priceAnomalyX.push(anomaly.index);
                            priceAnomalyY.push(yValue);
                            priceAnomalyText.push(anomaly.description);
                            priceAnomalyColors.push(color);
                        }
                    }
                });

                // Add price anomalies to price chart
                if (priceAnomalyX.length > 0) {
                    traces.push({
                        x: priceAnomalyX,
                        y: priceAnomalyY,
                        mode: 'markers',
                        type: 'scatter',
                        name: 'Price Anomalies',
                        xaxis: 'x',
                        yaxis: 'y',
                        marker: {
                            color: priceAnomalyColors,
                            size: 14,
                            symbol: 'circle',
                            opacity: 0.8,
                            line: {
                                color: 'white',
                                width: 2
                            }
                        },
                        text: priceAnomalyText,
                        hoverinfo: 'text',
                        showlegend: false
                    });
                }

                // Add volume anomalies to volume chart
                if (volumeAnomalyX.length > 0) {
                    traces.push({
                        x: volumeAnomalyX,
                        y: volumeAnomalyY,
                        mode: 'markers',
                        type: 'scatter',
                        name: 'Volume Anomalies',
                        xaxis: 'x',
                        yaxis: 'y2',  // Use y2 axis (volume chart)
                        marker: {
                            color: volumeAnomalyColors,
                            size: 14,
                            symbol: 'diamond',  // Different shape for volume anomalies
                            opacity: 0.8,
                            line: {
                                color: 'white',
                                width: 2
                            }
                        },
                        text: volumeAnomalyText,
                        hoverinfo: 'text',
                        showlegend: false
                    });
                }
            }

            // Volume bar trace using ALL accumulated data
            traces.push({
                x: xIndices,
                y: allChartData.volume,
                type: 'bar',
                name: 'Volume',
                xaxis: 'x',
                yaxis: 'y2',
                marker: {
                    color: allChartData.close.map((close, i) =>
                        i === 0 ? '#00cc96' : (close >= allChartData.open[i] ? '#00cc96' : '#ef553b')
                    ),
                    opacity: 0.5
                },
                showlegend: false
            });

            // Create adaptive tick labels based on time range using ALL data
            const tickSpacing = Math.max(1, Math.floor(allChartData.datetime.length / 10));
            const tickvals = [];
            const ticktext = [];

            // Calculate time span to determine format
            const firstDate = new Date(allChartData.datetime[0]);
            const lastDate = new Date(allChartData.datetime[allChartData.datetime.length - 1]);
            const timeSpanHours = (lastDate - firstDate) / (1000 * 60 * 60);

            for (let i = 0; i < allChartData.datetime.length; i += tickSpacing) {
                tickvals.push(i);

                // Adaptive formatting based on time span
                if (timeSpanHours < 48) {
                    // Less than 2 days: show time only (HH:MM)
                    ticktext.push(allChartData.datetime[i].split(' ')[1].substring(0, 5));
                } else if (timeSpanHours < 168) {
                    // Less than 1 week: show day and time (MM-DD HH:MM)
                    const parts = allChartData.datetime[i].split(' ');
                    const datePart = parts[0].substring(5); // MM-DD
                    const timePart = parts[1].substring(0, 5); // HH:MM
                    ticktext.push(datePart + ' ' + timePart);
                } else if (timeSpanHours < 720) {
                    // Less than 30 days: show month-day (MM-DD)
                    ticktext.push(allChartData.datetime[i].split(' ')[0].substring(5));
                } else {
                    // More than 30 days: show year-month-day (YYYY-MM-DD)
                    ticktext.push(allChartData.datetime[i].split(' ')[0]);
                }
            }

            // If auto-follow is enabled, center on latest data
            let xaxisConfig = {
                gridcolor: '#464651',
                rangeslider: { visible: false },
                tickvals: tickvals,
                ticktext: ticktext,
                tickangle: -45,
                fixedrange: false,
                domain: [0, 1]
            };

            if (autoFollow) {
                // Center on latest 100 points when locked
                const viewWindow = 100;
                const endIndex = allChartData.close.length - 1;
                const startIndex = Math.max(0, endIndex - viewWindow);
                xaxisConfig.range = [startIndex, endIndex];
                xaxisConfig.autorange = false;
            } else {
                xaxisConfig.autorange = false;  // Let user control when unlocked
            }

            const layout = {
                paper_bgcolor: '#262730',
                plot_bgcolor: '#262730',
                font: { color: '#fafafa' },
                xaxis: xaxisConfig,
                yaxis: {
                    domain: [0.25, 1],
                    gridcolor: '#464651',
                    autorange: true,
                    fixedrange: false,
                    title: 'Price'
                },
                yaxis2: {
                    domain: [0, 0.2],
                    gridcolor: '#464651',
                    autorange: true,
                    fixedrange: false,
                    title: 'Volume'
                },
                margin: { l: 50, r: 50, t: 20, b: 70 },
                height: 600,
                dragmode: 'pan',
                hovermode: 'closest',
                uirevision: 'true'
            };

            const config = {
                scrollZoom: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                displaylogo: false
            };

            Plotly.react('chart', traces, layout, config).then(function() {
                // Setup interaction detection after first render
                if (!window.chartInteractionSetup) {
                    setupChartInteraction();
                    window.chartInteractionSetup = true;
                }
            });
        });

        socket.on('streaming_complete', function() {
            document.getElementById('statusBadge').textContent = '‚úÖ Complete';
            document.getElementById('statusBadge').className = 'status-badge status-stopped';
        });
    </script>
</body>
</html>
